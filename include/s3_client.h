#ifndef S3_CLIENT_H_INCLUDED
#define S3_CLIENT_H_INCLUDED

/*
 * s3_client.h
 *
 * Публичное C-API S3-клиента.
 *
 * Этот заголовок описывает:
 *   - opaque-типы s3_env_t и s3_client_t;
 *   - функции инициализации/деинициализации;
 *   - операции: create bucket, PUT, GET, list, batch delete.
 *
 * Важно:
 *   - заголовок НЕ зависит от Tarantool;
 *   - детали потоков, coio и т.п. находятся в реализации .c;
 *   - для пользователя API все функции выглядят синхронными:
 *       int rc = s3_client_put_fd(...);
 *       if (rc != S3_OK) { ... }
 */

#include <stddef.h> /* size_t */

#include "s3_config.h" /* s3_env_config, s3_client_config */
#include "s3_types.h"  /* *_params, s3_object_info, callbacks */
#include "s3_error.h"  /* enum s3_error, s3_error_info */

#ifdef __cplusplus
extern "C" {
#endif

/* ----------------------------------------------------------------------
 * 0. Opaque-типы
 * ---------------------------------------------------------------------- */

/**
 * Глобальная среда S3-клиента.
 *
 * Содержит:
 *   - общие ресурсы libcurl (curl_global_init, curl_share и т.д.);
 *   - (в будущем) общую конфигурацию пулов, multi-хендл и т.д.
 *
 * Создаётся один раз на процесс и шарится между клиентами.
 */
typedef struct s3_env s3_env_t;

/**
 * Клиент S3.
 *
 * Описывает:
 *   - endpoint и регион;
 *   - креды;
 *   - настройки TLS и таймаутов;
 *   - (опционально) default bucket;
 *   - выбранный HTTP backend (curl_easy/curl_multi).
 *
 * Клиент потокобезопасен только в том объёме, в котором это
 * гарантируется реализацией. Библиотека может накладывать
 * ограничения (например, использовать клиент из одного треда).
 */
typedef struct s3_client s3_client_t;

/* ----------------------------------------------------------------------
 * 1. Инициализация и деинициализация среды
 * ---------------------------------------------------------------------- */

/**
 * Инициализация глобальной среды S3-клиента.
 *
 * Внутри:
 *   - может вызывать curl_global_init;
 *   - создаёт общие структуры и backend.
 *
 * Параметры:
 *   - penv    — указатель на переменную, куда будет записан s3_env_t*;
 *   - config  — конфигурация среды (может быть NULL → значения по умолчанию);
 *   - err     — (опционально) детализация ошибки.
 *
 * Возвращаемое значение:
 *   - S3_OK          — успех;
 *   - S3_ENOMEM      — не хватило памяти;
 *   - S3_ECURL       — ошибка libcurl;
 *   - S3_EINVAL      — неправильные аргументы;
 *   - другие коды из enum s3_error при необходимости.
 */
int  s3_env_init(s3_env_t **penv,
                 const struct s3_env_config *config,
                 struct s3_error_info *err);

/**
 * Освобождение глобальной среды.
 *
 * Допускается передавать NULL — в этом случае функция ничего не делает.
 * После вызова env использовать нельзя.
 */
void s3_env_destroy(s3_env_t *env);

/* ----------------------------------------------------------------------
 * 2. Инициализация и деинициализация клиента
 * ---------------------------------------------------------------------- */

/**
 * Создание клиента S3.
 *
 * Параметры:
 *   - env      — ранее инициализированная среда s3_env_t;
 *   - config   — конфигурация клиента (обязательна);
 *   - pclient  — указатель на переменную, куда будет записан s3_client_t*;
 *   - err      — (опционально) детализация ошибки.
 *
 * Возвращаемое значение:
 *   - S3_OK          — успех;
 *   - S3_ENOMEM      — не хватило памяти;
 *   - S3_EINVAL      — некорректный config или аргументы;
 *   - S3_ECURL       — ошибка инициализации HTTP/backend;
 *   - другие коды enum s3_error по необходимости.
 */
int  s3_client_new(s3_env_t *env,
                   const struct s3_client_config *config,
                   s3_client_t **pclient,
                   struct s3_error_info *err);

/**
 * Уничтожение клиента S3.
 *
 * Допускается передавать NULL — тогда функция ничего не делает.
 * После вызова client использовать нельзя.
 */
void s3_client_delete(s3_client_t *client);

/* ----------------------------------------------------------------------
 * 3. Операции на уровне бакета
 * ---------------------------------------------------------------------- */

/**
 * Создать бакет.
 *
 * Параметры:
 *   - client  — клиент S3;
 *   - bucket  — имя бакета (обязательное поле, не NULL);
 *   - params  — параметры создания (может быть NULL → значения по умолчанию);
 *   - err     — (опционально) детализация ошибки.
 *
 * Возвращаемое значение:
 *   - S3_OK      — бакет создан или уже существует (зависит от реализации);
 *   - S3_EHTTP   — сервер вернул ошибку (смотри err->http_status);
 *   - S3_EAUTH   — ошибка авторизации/подписи;
 *   - S3_ESERVER — ошибка 5xx;
 *   - S3_ENETWORK / S3_ECURL и т.д.
 *
 * Примечание для варианта с Tarantool:
 *   - предполагается, что эта функция вызывается из fiber на tx-треде;
 *   - реализация внутри выполнит работу через coio_call на worker-треде.
 */
int  s3_client_create_bucket(s3_client_t *client,
                             const char *bucket,
                             const struct s3_create_bucket_params *params,
                             struct s3_error_info *err);

/* ----------------------------------------------------------------------
 * 4. PUT / GET (работа с объектами через fd)
 * ---------------------------------------------------------------------- */

/**
 * PUT: загрузить объект из fd в S3.
 *
 * Параметры:
 *   - client  — клиент S3;
 *   - bucket  — имя бакета; если NULL → используется default_bucket;
 *   - key     — ключ (имя объекта) внутри бакета;
 *   - src_fd  — файловый дескриптор, откуда читаем данные;
 *   - params  — параметры PUT (длина, content_type и т.п.), обязательны;
 *   - err     — (опционально) детализация ошибки.
 *
 * Поведение:
 *   - читает из src_fd до params->content_length байт (или меньше при ошибке);
 *   - отправляет данные в S3/MinIO;
 *   - синхронно возвращает результат.
 *
 * Возвращаемое значение:
 *   - S3_OK        — успешная загрузка;
 *   - S3_EIO       — локальная ошибка чтения src_fd;
 *   - S3_EHTTP     — HTTP ошибка (4xx/5xx);
 *   - S3_EAUTH     — ошибка авторизации;
 *   - S3_ENETWORK  — сетевые проблемы;
 *   - S3_ECURL     — ошибка libcurl;
 *   - S3_ECANCELLED — операция прервана извне (например, отменён fiber).
 */
int  s3_client_put_fd(s3_client_t *client,
                      const char *bucket,
                      const char *key,
                      int src_fd,
                      const struct s3_put_params *params,
                      struct s3_error_info *err);

/**
 * GET: скачать объект из S3 в fd.
 *
 * Параметры:
 *   - client  — клиент S3;
 *   - bucket  — имя бакета; если NULL → используется default_bucket;
 *   - key     — ключ (имя объекта);
 *   - dst_fd  — файловый дескриптор, куда пишем данные;
 *   - params  — параметры GET (offset/limit), может быть NULL → читать весь объект;
 *   - err     — (опционально) детализация ошибки.
 *
 * Поведение:
 *   - читает данные объекта (или его часть, если задан Range через params);
 *   - записывает в dst_fd;
 *   - синхронно возвращает результат.
 *
 * Возвращаемое значение:
 *   - S3_OK        — успешная загрузка;
 *   - S3_EIO       — локальная ошибка записи dst_fd;
 *   - S3_EHTTP     — HTTP ошибка (например, 404 при отсутствии объекта);
 *   - S3_EAUTH     — ошибка авторизации;
 *   - S3_ENETWORK  — сетевые проблемы;
 *   - S3_ECURL     — ошибка libcurl;
 *   - S3_ECANCELLED — операция прервана извне.
 */
int  s3_client_get_fd(s3_client_t *client,
                      const char *bucket,
                      const char *key,
                      int dst_fd,
                      const struct s3_get_params *params,
                      struct s3_error_info *err);

/* ----------------------------------------------------------------------
 * 5. List объектов в бакете
 * ---------------------------------------------------------------------- */

/**
 * List объектов в бакете.
 *
 * Параметры:
 *   - client   — клиент S3;
 *   - bucket   — имя бакета; если NULL → используется default_bucket;
 *   - params   — параметры list (prefix, delimiter, max_keys, recursive),
 *                может быть NULL → значения по умолчанию;
 *   - cb       — callback, вызываемый для каждого найденного объекта/префикса;
 *   - userdata — произвольный указатель, передаётся в cb как есть;
 *   - err      — (опционально) детализация ошибки.
 *
 * Поведение:
 *   - под капотом вызывает ListObjectsV2 (или аналог);
 *   - ходит по continuation token'ам до тех пор, пока:
 *       * не закончатся объекты;
 *       * или cb не вернёт ненулевое значение (тогда листинг прерывается).
 *
 * Важно:
 *   - строки внутри s3_object_info (key, etag, last_modified) могут ссылаться
 *     на временные буферы; не сохраняйте их после возврата из cb, если это
 *     отдельно не оговорено реализацией;
 *   - cb должен быть достаточно быстрым и не блокировать “навсегда”.
 *
 * Возвращаемое значение:
 *   - S3_OK        — операция завершена (даже если cb рано остановил листинг);
 *   - S3_EHTTP     — сервер вернул ошибку;
 *   - S3_ENETWORK  — сетевые проблемы;
 *   - S3_ECURL     — проблемы с libcurl;
 *   - S3_ECANCELLED — операция прервана (например, завершён fiber).
 */
int  s3_client_list_objects(s3_client_t *client,
                            const char *bucket,
                            const struct s3_list_params *params,
                            s3_list_object_cb cb,
                            void *userdata,
                            struct s3_error_info *err);

/* ----------------------------------------------------------------------
 * 6. Batch delete (массовое удаление объектов)
 * ---------------------------------------------------------------------- */

/**
 * Batch delete объектов в бакете.
 *
 * Параметры:
 *   - client    — клиент S3;
 *   - bucket    — имя бакета; если NULL → используется default_bucket;
 *   - keys      — массив указателей на строковые ключи (C-строки);
 *   - key_count — количество элементов в массиве keys;
 *   - params    — дополнительные параметры (quiet), может быть NULL;
 *   - cb        — (опционально) callback по результату для каждого ключа;
 *   - userdata  — (опционально) пользовательские данные для cb;
 *   - err       — (опционально) детализация общей ошибки операции.
 *
 * Поведение:
 *   - разбивает список ключей на батчи по лимиту S3 (обычно 1000);
 *   - для каждого батча отправляет DeleteObjects;
 *   - если cb != NULL, вызывает его по каждому ключу, для которого сервер
 *     вернул результат (успех или ошибку).
 *
 * Важно:
 *   - даже если cb возвращает ненулевое значение (просит остановиться),
 *     HTTP-запрос уже выполнен; библиотека просто перестаёт вызывать cb для
 *     оставшихся результатов;
 *   - при quiet=1 сервер может не прислать успехи для каждого ключа, но ошибки
 *     всё равно будут отражены.
 *
 * Возвращаемое значение:
 *   - S3_OK        — операция DeleteObjects успешно выполнена для всех батчей
 *                    (с точки зрения HTTP и сетевого уровня);
 *                    при этом отдельные ключи могли быть не удалены (смотри cb
 *                    и/или err->msg для деталей);
 *   - S3_EHTTP     — ошибка протокола (например, отказ сервера целиком);
 *   - S3_ENETWORK  — сетевые проблемы;
 *   - S3_ECURL     — проблемы с libcurl;
 *   - S3_ECANCELLED — операция прервана.
 */
int  s3_client_delete_objects(s3_client_t *client,
                              const char *bucket,
                              const char * const *keys,
                              size_t key_count,
                              const struct s3_delete_params *params,
                              s3_delete_result_cb cb,
                              void *userdata,
                              struct s3_error_info *err);

#ifdef __cplusplus
} /* extern "C" */
#endif

#endif /* S3_CLIENT_H_INCLUDED */
