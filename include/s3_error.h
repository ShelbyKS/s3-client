#ifndef S3_ERROR_H_INCLUDED
#define S3_ERROR_H_INCLUDED

/*
 * s3_error.h
 *
 * Общие коды ошибок и структуры для описания ошибки в S3-клиенте.
 *
 * Идея:
 *  - enum s3_error — компактный high-level код (для if/return);
 *  - struct s3_error_info — расширенная информация (HTTP статус, текст);
 *  - вспомогательные функции для заполнения/сброса ошибки.
 */

#include <stddef.h> /* size_t */
#include <stdint.h> /* стандартные целочисленные типы */

#ifdef __cplusplus
extern "C" {
#endif

/**
 * High-level коды ошибок библиотеки.
 *
 * Они намеренно грубые/обобщённые:
 *  - чтобы не протаскивать наружу детали libcurl / системных errno;
 *  - чтобы их было удобно обрабатывать и в C, и на уровне Lua.
 *
 * Детали (HTTP-коды, текст из CURL и т.п.) идут в s3_error_info.
 */
enum s3_error {
    /**
     * Успешное завершение операции.
     */
    S3_OK = 0,

    /**
     * Неверные аргументы функции (NULL указатель, некорректный размер и т.п.).
     */
    S3_EINVAL,

    /**
     * Не удалось выделить память (malloc/calloc/realloc вернул NULL).
     */
    S3_ENOMEM,

    /**
     * Ошибка ввода-вывода на локальной стороне:
     *  - чтение/запись fd;
     *  - ошибки файловой системы;
     *  - и т.п.
     */
    S3_EIO,

    /**
     * Ошибка сетевого уровня:
     *  - не удалось установить соединение;
     *  - таймауты на уровне TCP;
     *  - закрыто соединение и т.п.
     */
    S3_ENETWORK,

    /**
     * Сервер вернул HTTP-ошибку (код >= 400).
     * Конкретный HTTP статус смотрим в s3_error_info.http_status.
     */
    S3_EHTTP,

    /**
     * Внутренняя ошибка libcurl (CURLE_*).
     * Текстовое описание ошибки — в s3_error_info.msg.
     */
    S3_ECURL,

    /**
     * Ошибка аутентификации/авторизации:
     *  - неправильные креды;
     *  - подпись SigV4 не прошла;
     *  - отсутствуют права на операцию и т.п.
     */
    S3_EAUTH,

    /**
     * Ошибка на стороне сервера:
     *  - 5xx HTTP статусы;
     *  - или другая проблема, которую библиотека считает “серверной”.
     */
    S3_ESERVER,

    /**
     * Операция была отменена:
     *  - завершён файбер;
     *  - произошёл таймаут на уровне tarantool/coio;
     *  - или другой внешний прерывающий фактор.
     */
    S3_ECANCELLED,
};

/**
 * Расширенная информация об ошибке.
 *
 * Создаётся и заполняется библиотекой при выполнении операций.
 * Пользователь может:
 *  - смотреть code (enum s3_error);
 *  - смотреть http_status (если был HTTP-запрос);
 *  - читать msg для логов/диагностики.
 */
struct s3_error_info {
    /**
     * High-level код ошибки (см. enum s3_error).
     * S3_OK означает успех операции.
     */
    int  code;

    /**
     * HTTP статус ответа сервера, если он есть.
     *  - 0, если запрос до HTTP уровня не дошёл (например, ошибка DNS);
     *  - >0, если сервер вернул статус (200, 404, 500 и т.п.).
     */
    long http_status;

    /**
     * Краткое человекочитаемое описание ошибки.
     *  - Используется для логов и отладки;
     *  - Гарантированно нуль-терминированная строка.
     */
    char msg[256];
};

/**
 * Инициализировать структуру s3_error_info значениями "без ошибки".
 *
 * Полезно, если вызывающий код держит s3_error_info на стеке и хочет
 * явно сбросить прошлое состояние перед новой операцией.
 *
 * Пример:
 *
 *     struct s3_error_info err;
 *     s3_error_reset(&err);
 *     int rc = s3_client_put_fd(..., &err);
 *     if (rc != S3_OK) {
 *         fprintf(stderr, "put failed: %s\n", err.msg);
 *     }
 */
void s3_error_reset(struct s3_error_info *err);

/**
 * Получить строковое представление кода ошибки.
 *
 * Важно:
 *  - возвращает const char* на статически выделенные строки;
 *  - НЕ использует s3_error_info.msg (т.е. это “общие” тексты для кода).
 *
 * Для форматированного вывода конкретной операции чаще удобнее использовать
 * s3_error_info.msg, который задаётся библиотекой при ошибке.
 *
 * Пример:
 *
 *     int rc = s3_client_get_fd(..., &err);
 *     if (rc != S3_OK) {
 *         fprintf(stderr, "code=%d (%s), http=%ld, msg=%s\n",
 *                 err.code, s3_strerror(err.code),
 *                 err.http_status, err.msg);
 *     }
 */
const char *s3_strerror(int code);

#ifdef __cplusplus
} /* extern "C" */
#endif

#endif /* S3_ERROR_H_INCLUDED */
